name: Build & Release Plugin ZIP

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build ZIP
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ZIP="wc-stock-sync-dwenn-${VERSION}.zip"
          zip -r "$ZIP" wc-stock-sync-dwenn -x "*.DS_Store" -x "__MACOSX/*"
          echo "ZIP_NAME=$ZIP" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Extract release notes from CHANGELOG.md
        id: notes
        shell: bash
        run: |
          VERSION="${{ env.VERSION }}"
          FILE="CHANGELOG.md"

          if [ ! -f "$FILE" ]; then
            echo "CHANGELOG.md not found. Using autogenerated notes."
            echo "HAS_NOTES=false" >> $GITHUB_ENV
            exit 0
          fi

          # Extract the section for: ## [1.3.0] - ...
          # It grabs everything until the next "## [" header.
          NOTES=$(awk -v ver="$VERSION" '
            BEGIN {found=0}
            $0 ~ "^## \\[" ver "\\]" {found=1; print; next}
            found && $0 ~ "^## \\[" {exit}
            found {print}
          ' "$FILE")

          # If empty, fallback to auto notes
          if [ -z "$NOTES" ]; then
            echo "No matching section in CHANGELOG for version $VERSION"
            echo "HAS_NOTES=false" >> $GITHUB_ENV
            exit 0
          fi

          {
            echo "HAS_NOTES=true"
            echo "RELEASE_BODY<<EOF"
            echo "$NOTES"
            echo ""
            echo "---"
            echo ""
            echo "**Install:** Download the ZIP asset and upload it in WP Admin → Plugins → Add New → Upload Plugin."
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Create GitHub Release (with changelog notes)
        if: env.HAS_NOTES == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_NAME }}
          body: ${{ env.RELEASE_BODY }}

      - name: Create GitHub Release (autogenerated notes fallback)
        if: env.HAS_NOTES != 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_NAME }}
          generate_release_notes: true
